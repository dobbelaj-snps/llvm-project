; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -passes=inline -enable-noalias-to-md-conversion --use-noalias-intrinsic-during-inlining=scopes -S | FileCheck %s --match-full-lines  --check-prefixes=CHECK_SCOPES
; RUN: opt < %s -passes=inline -enable-noalias-to-md-conversion --use-noalias-intrinsic-during-inlining=full -S | FileCheck %s --match-full-lines  --check-prefixes=CHECK_FULL

define i32 @caller(ptr %p) {
; CHECK_SCOPES-LABEL: {{.*}}@caller({{.*}}
; CHECK_SCOPES-NEXT:    call void @llvm.experimental.noalias.scope.decl(metadata [[META0:![0-9]+]])
; CHECK_SCOPES-NEXT:    [[P_8_I:%.*]] = getelementptr i8, ptr [[P:%.*]], i64 8
; CHECK_SCOPES-NEXT:    [[V_I:%.*]] = load i32, ptr [[P_8_I]], align 4, !alias.scope !0
; CHECK_SCOPES-NEXT:    [[P_1_I:%.*]] = getelementptr i8, ptr [[P]], i64 1
; CHECK_SCOPES-NEXT:    [[P_2_I:%.*]] = getelementptr i8, ptr [[P_1_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_3_I:%.*]] = getelementptr i8, ptr [[P_2_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_4_I:%.*]] = getelementptr i8, ptr [[P_3_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_5_I:%.*]] = getelementptr i8, ptr [[P_4_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_6_I:%.*]] = getelementptr i8, ptr [[P_5_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_7_I:%.*]] = getelementptr i8, ptr [[P_6_I]], i64 1
; CHECK_SCOPES-NEXT:    [[P_8_ALIAS_I:%.*]] = getelementptr i8, ptr [[P_7_I]], i64 1
; CHECK_SCOPES-NEXT:    store i32 42, ptr [[P_8_ALIAS_I]], align 4
; CHECK_SCOPES-NEXT:    ret i32 [[V_I]]
;
; CHECK_FULL-LABEL: {{.*}}@caller({{.*}}
; CHECK_FULL-NEXT:    [[TMP1:%.*]] = call ptr @llvm.noalias.decl.p0.p0.i64(ptr null, i64 0, metadata [[META0:![0-9]+]])
; CHECK_FULL-NEXT:    [[TMP2:%.*]] = call ptr @llvm.noalias.p0.p0.p0.i64(ptr [[P:%.*]], ptr [[TMP1]], ptr null, i64 0, metadata [[META0]]), !noalias !0
; CHECK_FULL-NEXT:    [[P_8_I:%.*]] = getelementptr i8, ptr [[TMP2]], i64 8
; CHECK_FULL-NEXT:    [[V_I:%.*]] = load i32, ptr [[P_8_I]], align 4, !noalias !0
; CHECK_FULL-NEXT:    [[P_1_I:%.*]] = getelementptr i8, ptr [[TMP2]], i64 1
; CHECK_FULL-NEXT:    [[P_2_I:%.*]] = getelementptr i8, ptr [[P_1_I]], i64 1
; CHECK_FULL-NEXT:    [[P_3_I:%.*]] = getelementptr i8, ptr [[P_2_I]], i64 1
; CHECK_FULL-NEXT:    [[P_4_I:%.*]] = getelementptr i8, ptr [[P_3_I]], i64 1
; CHECK_FULL-NEXT:    [[P_5_I:%.*]] = getelementptr i8, ptr [[P_4_I]], i64 1
; CHECK_FULL-NEXT:    [[P_6_I:%.*]] = getelementptr i8, ptr [[P_5_I]], i64 1
; CHECK_FULL-NEXT:    [[P_7_I:%.*]] = getelementptr i8, ptr [[P_6_I]], i64 1
; CHECK_FULL-NEXT:    [[P_8_ALIAS_I:%.*]] = getelementptr i8, ptr [[P_7_I]], i64 1
; CHECK_FULL-NEXT:    store i32 42, ptr [[P_8_ALIAS_I]], align 4, !noalias !0
; CHECK_FULL-NEXT:    ret i32 [[V_I]]
;
  %v = call i32 @callee(ptr %p)
  ret i32 %v
}

define internal i32 @callee(ptr noalias %p) {
  %p.8 = getelementptr i8, ptr %p, i64 8
  %v = load i32, ptr %p.8
  %p.1 = getelementptr i8, ptr %p, i64 1
  %p.2 = getelementptr i8, ptr %p.1, i64 1
  %p.3 = getelementptr i8, ptr %p.2, i64 1
  %p.4 = getelementptr i8, ptr %p.3, i64 1
  %p.5 = getelementptr i8, ptr %p.4, i64 1
  %p.6 = getelementptr i8, ptr %p.5, i64 1
  %p.7 = getelementptr i8, ptr %p.6, i64 1
  %p.8.alias = getelementptr i8, ptr %p.7, i64 1
  store i32 42, ptr %p.8.alias
  ret i32 %v
}
